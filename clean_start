#!/bin/bash

# ModernAgile.org Website - Clean Start Script
# Reset to pristine development state with latest changes

set -e  # Exit on any error

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR"

echo "Clean Start: Reset to pristine development state"
echo

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not in a git repository"
    exit 1
fi

# Check if we're in the right directory
if [[ ! -f "$PROJECT_ROOT/index.html" ]] || [[ ! -d "$PROJECT_ROOT/tests" ]]; then
    echo "Error: This script must be run from the ModernAgile project root directory"
    echo "Expected to find index.html and tests/ directory"
    exit 1
fi

# Step 1: Pull latest changes with rebase (will fail if unstaged changes)
echo "Step 1/4: Pulling latest changes..."
echo "(This will fail if you have unstaged changes - commit or stash them first)"

if ! git pull -r; then
    echo "Error: Git pull failed. Please resolve conflicts manually and try again."
    exit 1
fi

# Step 2: Interactive cleanup of untracked files
echo
echo "Step 2/4: Cleaning untracked files..."

UNTRACKED_FILES=$(git status --porcelain | grep '^??' || true)

if [[ -z "$UNTRACKED_FILES" ]]; then
    echo "No untracked files found."
else
    echo "Found untracked files that can be cleaned:"
    echo "$UNTRACKED_FILES"
    echo
    echo "Starting interactive cleanup (you can cancel safely)..."
    
    # Interactive git clean - user has full control
    if ! git clean -i; then
        echo "Clean operation cancelled by user. Exiting."
        exit 1
    fi
fi

# Step 3: Update dependencies
echo
echo "Step 3/4: Installing/updating integration test dependencies..."

cd "$PROJECT_ROOT/integration-tests"

if [[ ! -f "package.json" ]]; then
    echo "Warning: No package.json found in integration-tests directory"
    cd "$PROJECT_ROOT"
else
    if ! npm install; then
        echo "Error: Failed to install integration test dependencies"
        exit 1
    fi
    cd "$PROJECT_ROOT"
fi

# Step 4: Run modern integration tests
echo
echo "Step 4/4: Running integration tests to verify clean state..."

cd "$PROJECT_ROOT/integration-tests"

if ! npm test; then
    echo
    echo "Warning: Integration tests failed after clean start"
    echo "This may indicate issues with the latest changes or environment"
    cd "$PROJECT_ROOT"
    exit 1
fi

cd "$PROJECT_ROOT"

# Success
echo
echo "Clean start completed successfully!"
echo "Repository is now clean, updated, and tested."